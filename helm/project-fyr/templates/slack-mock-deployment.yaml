{{- if .Values.slackMock.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "project-fyr.fullname" . }}-slack-mock
  labels:
    {{- include "project-fyr.labels" . | nindent 4 }}
    app.kubernetes.io/component: slack-mock
spec:
  replicas: {{ .Values.slackMock.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: slack-mock
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: slack-mock
        app.kubernetes.io/name: project-fyr
    spec:
      {{- with .Values.slackMock.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: slack-mock
        image: "{{ .Values.slackMock.image.repository }}:{{ .Values.slackMock.image.tag }}"
        imagePullPolicy: {{ .Values.slackMock.image.pullPolicy }}
        command:
        - python
        - -u
        - -c
        - |
          from http.server import HTTPServer, BaseHTTPRequestHandler
          import json
          import sys
          from datetime import datetime
          from urllib.parse import parse_qs

          class SlackMockHandler(BaseHTTPRequestHandler):
              def log_message(self, format, *args):
                  # Override to use stdout instead of stderr
                  sys.stdout.write("%s - - [%s] %s\n" %
                                 (self.address_string(),
                                  self.log_date_time_string(),
                                  format%args))
                  sys.stdout.flush()
              
              def do_POST(self):
                  content_length = int(self.headers.get('Content-Length', 0))
                  body = self.rfile.read(content_length).decode('utf-8')
                  
                  timestamp = datetime.now().isoformat()
                  
                  # Slack API Mock - handle chat.postMessage endpoint
                  if self.path.startswith('/api/chat.postMessage'):
                      try:
                          # Slack SDK sends data as form-encoded or JSON
                          content_type = self.headers.get('Content-Type', '')
                          
                          if 'application/json' in content_type:
                              data = json.loads(body)
                          else:
                              # Parse form-encoded data
                              parsed = parse_qs(body)
                              data = {k: v[0] if len(v) == 1 else v for k, v in parsed.items()}
                              # Parse blocks if present
                              if 'blocks' in data:
                                  try:
                                      data['blocks'] = json.loads(data['blocks'])
                                  except:
                                      pass
                          
                          channel = data.get('channel', 'unknown')
                          text = data.get('text', '')
                          blocks = data.get('blocks', [])
                          
                          print(f"\n{'='*80}")
                          print(f"[{timestamp}] ðŸš¨ SLACK NOTIFICATION RECEIVED")
                          print(f"{'='*80}")
                          print(f"Channel: {channel}")
                          
                          if text:
                              print(f"\nText: {text}")
                          
                          if blocks:
                              print(f"\nFormatted Message:")
                              print(f"{'-'*80}")
                              for block in blocks:
                                  if block.get('type') == 'section':
                                      fields = block.get('fields', [])
                                      for field in fields:
                                          if field.get('type') == 'mrkdwn':
                                              print(f"  {field.get('text', '')}")
                                      
                                      text_obj = block.get('text', {})
                                      if text_obj and text_obj.get('type') == 'mrkdwn':
                                          print(f"  {text_obj.get('text', '')}")
                                  elif block.get('type') == 'divider':
                                      print(f"  {'-'*60}")
                          
                          print(f"\nRaw Payload:")
                          print(json.dumps(data, indent=2))
                          print(f"{'='*80}\n")
                          sys.stdout.flush()
                      except Exception as e:
                          print(f"Error parsing Slack message: {e}")
                          print(f"Body: {body}")
                          sys.stdout.flush()
                      
                      # Send Slack API success response
                      self.send_response(200)
                      self.send_header('Content-Type', 'application/json')
                      self.end_headers()
                      response = json.dumps({
                          'ok': True,
                          'channel': data.get('channel', 'C0000000'),
                          'ts': str(datetime.now().timestamp()),
                          'message': {
                              'type': 'message',
                              'text': data.get('text', ''),
                              'user': 'U0000000',
                              'ts': str(datetime.now().timestamp())
                          }
                      })
                      self.wfile.write(response.encode())
                  else:
                      # Handle other endpoints
                      print(f"\n[{timestamp}] Request to {self.path}")
                      print(f"Body: {body}")
                      sys.stdout.flush()
                      
                      self.send_response(200)
                      self.send_header('Content-Type', 'application/json')
                      self.end_headers()
                      response = json.dumps({'ok': True})
                      self.wfile.write(response.encode())
              
              def do_GET(self):
                  self.send_response(200)
                  self.send_header('Content-Type', 'text/plain')
                  self.end_headers()
                  self.wfile.write(b'Slack Mock API Server - Ready\n')

          if __name__ == '__main__':
              server_address = ('', 8080)
              httpd = HTTPServer(server_address, SlackMockHandler)
              print('='*80)
              print('Slack Mock API Server starting on port 8080...')
              print('Handling endpoints: /api/chat.postMessage')
              print('Waiting for Slack notifications from Project Fyr...')
              print('='*80)
              sys.stdout.flush()
              httpd.serve_forever()
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        resources:
          {{- toYaml .Values.slackMock.resources | nindent 10 }}
      {{- with .Values.slackMock.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.slackMock.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.slackMock.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
